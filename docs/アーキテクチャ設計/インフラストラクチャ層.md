# ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤

## ğŸ“Œ æ¦‚è¦

ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤ã¯ã€æŠ€è¡“çš„ãªå®Ÿè£…è©³ç´°ã‚’æ‹…å½“ã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã€å¤–éƒ¨ API é€£æºã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãªã©ã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚„æŠ€è¡“ã«ä¾å­˜ã™ã‚‹éƒ¨åˆ†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

### ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤ã®å½¹å‰²

- **æ°¸ç¶šåŒ–ã®å®Ÿè£…**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»å–å¾—
- **å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€£æº**: å¤–éƒ¨ APIã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã€ãƒ•ã‚¡ã‚¤ãƒ« I/O
- **æŠ€è¡“çš„è©³ç´°ã®éš è”½**: ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ãŒæŠ€è¡“ã«ä¾å­˜ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
- **ãƒªãƒã‚¸ãƒˆãƒªã®å®Ÿè£…**: ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…

---

## ğŸ—ï¸ ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤ã®æ§‹æˆ

```
infrastructure/
  â”” persistence/                â† æ°¸ç¶šåŒ–é–¢é€£
      â”œ entity/                     â† JPA ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
      â”‚   â”” {Aggregate}Entity.java
      â”œ mapper/                     â† ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ« â†” JPA ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å¤‰æ›
      â”‚   â”” {Aggregate}PersistenceMapper.java
      â”” repository/                 â† ãƒªãƒã‚¸ãƒˆãƒªå®Ÿè£…
          â”œ {Aggregate}JpaRepository.java      â† Spring Data JPA
          â”” {Aggregate}RepositoryImpl.java     â† ãƒ‰ãƒ¡ã‚¤ãƒ³IFå®Ÿè£…
```

**ä¾‹: Film é›†ç´„ã®å ´åˆ**

```
infrastructure/
  â”” persistence/
      â”œ entity/
      â”‚   â”” FilmEntity.java
      â”œ mapper/
      â”‚   â”” FilmPersistenceMapper.java
      â”” repository/
          â”œ FilmJpaRepository.java
          â”” FilmRepositoryImpl.java
```

---

## ğŸ¯ ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤ã®æ§‹æˆè¦ç´ 

### 1. JPA ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆEntityï¼‰

JPA ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã‚‹ Java ã‚¯ãƒ©ã‚¹ã§ã™ã€‚

#### åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³

```java
@Entity
@Table(name = "{table_name}")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class {Aggregate}Entity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "id")
    private Long id;

    @Column(name = "property1", nullable = false)
    private String property1;

    @Column(name = "property2", length = 500)
    private String property2;

    @Column(name = "property3")
    private Integer property3;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
}
```

#### è¨­è¨ˆã®ãƒã‚¤ãƒ³ãƒˆ

1. **@Entity ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**
   - JPA ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™
   - Hibernate ãŒç®¡ç†ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

2. **@Table ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**
   - ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’æŒ‡å®š
   - çœç•¥æ™‚ã¯ã‚¯ãƒ©ã‚¹åãŒãƒ†ãƒ¼ãƒ–ãƒ«åã«ãªã‚‹

3. **@Id ã¨ @GeneratedValue**
   - ä¸»ã‚­ãƒ¼ã‚’æŒ‡å®š
   - `GenerationType.IDENTITY`: DB ã® AUTO_INCREMENT ã‚’ä½¿ç”¨
   - `GenerationType.SEQUENCE`: ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’ä½¿ç”¨ï¼ˆPostgreSQL ãªã©ï¼‰
   - `GenerationType.AUTO`: JPA ãƒ—ãƒ­ãƒã‚¤ãƒ€ãŒè‡ªå‹•é¸æŠ

4. **@Column ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**
   - ã‚«ãƒ©ãƒ åã€åˆ¶ç´„ã‚’æŒ‡å®š
   - `nullable`: NULL è¨±å¯/ä¸è¨±å¯
   - `length`: æ–‡å­—åˆ—ã®é•·ã•
   - `unique`: ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„
   - `updatable`: æ›´æ–°å¯èƒ½/ä¸å¯

5. **ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹ã‚’ä½¿ç”¨**
   - ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã¨ã¯ç•°ãªã‚Šã€ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹ã‚’ä½¿ç”¨
   - JPA ã¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°ãŒå®¹æ˜“

---

#### JPA ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®è©³ç´°

##### åŸºæœ¬çš„ãªãƒãƒƒãƒ”ãƒ³ã‚°

```java
// ã‚«ãƒ©ãƒ åã®æ˜ç¤ºçš„ãªæŒ‡å®š
@Column(name = "user_name")
private String userName;

// NULL ä¸å¯
@Column(nullable = false)
private String requiredField;

// ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„
@Column(unique = true)
private String email;

// æ–‡å­—åˆ—ã®é•·ã•æŒ‡å®š
@Column(length = 100)
private String shortText;

// TEXT å‹
@Column(columnDefinition = "TEXT")
private String longText;

// æ›´æ–°ä¸å¯ï¼ˆä½œæˆæ™‚ã®ã¿è¨­å®šï¼‰
@Column(updatable = false)
private LocalDateTime createdAt;

// æŒ¿å…¥ä¸å¯ï¼ˆæ›´æ–°æ™‚ã®ã¿è¨­å®šï¼‰
@Column(insertable = false)
private LocalDateTime lastModifiedAt;
```

##### æ—¥æ™‚ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

```java
// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆè‡ªå‹•è¨­å®šï¼‰
@CreatedDate
@Column(name = "created_at", updatable = false)
private LocalDateTime createdAt;

@LastModifiedDate
@Column(name = "updated_at")
private LocalDateTime updatedAt;

// ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒªã‚¹ãƒŠãƒ¼ã‚’æœ‰åŠ¹åŒ–
@EntityListeners(AuditingEntityListener.class)
public class FilmEntity {
    // ...
}
```

**Spring Data JPA ã®ç›£æŸ»æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–**:

```java
@Configuration
@EnableJpaAuditing
public class JpaConfig {
}
```

##### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—

###### å¤šå¯¾ä¸€ï¼ˆ@ManyToOneï¼‰

```java
@Entity
public class OrderEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    // å¤šå¯¾ä¸€: å¤šæ•°ã®æ³¨æ–‡ãŒ1äººã®é¡§å®¢ã«å±ã™ã‚‹
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "customer_id", nullable = false)
    private CustomerEntity customer;
}
```

###### ä¸€å¯¾å¤šï¼ˆ@OneToManyï¼‰

```java
@Entity
public class CustomerEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    // ä¸€å¯¾å¤š: 1äººã®é¡§å®¢ãŒå¤šæ•°ã®æ³¨æ–‡ã‚’æŒã¤
    @OneToMany(mappedBy = "customer", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<OrderEntity> orders = new ArrayList<>();
}
```

###### ä¸€å¯¾ä¸€ï¼ˆ@OneToOneï¼‰

```java
@Entity
public class UserEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    // ä¸€å¯¾ä¸€: 1äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ1ã¤ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æŒã¤
    @OneToOne(cascade = CascadeType.ALL)
    @JoinColumn(name = "profile_id", unique = true)
    private ProfileEntity profile;
}
```

###### å¤šå¯¾å¤šï¼ˆ@ManyToManyï¼‰

```java
@Entity
public class StudentEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    // å¤šå¯¾å¤š: å¤šæ•°ã®å­¦ç”ŸãŒå¤šæ•°ã®ã‚³ãƒ¼ã‚¹ã‚’å—è¬›
    @ManyToMany
    @JoinTable(
        name = "student_course",
        joinColumns = @JoinColumn(name = "student_id"),
        inverseJoinColumns = @JoinColumn(name = "course_id")
    )
    private Set<CourseEntity> courses = new HashSet<>();
}
```

##### FetchType ã®é¸æŠ

```java
// LAZYï¼ˆæ¨å¥¨ï¼‰: å¿…è¦ã«ãªã£ãŸã¨ãã«å–å¾—
@ManyToOne(fetch = FetchType.LAZY)
private CustomerEntity customer;

// EAGER: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨ä¸€ç·’ã«å³åº§ã«å–å¾—
@ManyToOne(fetch = FetchType.EAGER)
private CustomerEntity customer;
```

**æ¨å¥¨**: åŸºæœ¬çš„ã« `FetchType.LAZY` ã‚’ä½¿ç”¨ã—ã€N+1 å•é¡Œã¯ `@EntityGraph` ã‚„ JOIN FETCH ã§å¯¾å¿œ

---

### 2. æ°¸ç¶šåŒ–ãƒãƒƒãƒ‘ãƒ¼ï¼ˆPersistence Mapperï¼‰

æ°¸ç¶šåŒ–ãƒãƒƒãƒ‘ãƒ¼ã¯ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã¨ JPA ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç›¸äº’å¤‰æ›ã‚’è¡Œã„ã¾ã™ã€‚

#### åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³

```java
@Component
public class {Aggregate}PersistenceMapper {

    /**
     * ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ« â†’ JPA ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
     */
    public {Aggregate}Entity toEntity({Aggregate} domain) {
        if (domain == null) {
            return null;
        }

        {Aggregate}Entity entity = new {Aggregate}Entity();

        // ID ã®å¤‰æ›
        if (domain.getId() != null) {
            entity.setId(domain.getId().getValue());
        }

        // å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ â†’ ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹
        entity.setProperty1(domain.getProperty1().getValue());
        entity.setProperty2(domain.getProperty2().getValue());
        entity.setProperty3(domain.getProperty3().getValue());

        return entity;
    }

    /**
     * JPA ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ â†’ ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«
     */
    public {Aggregate} toDomain({Aggregate}Entity entity) {
        if (entity == null) {
            return null;
        }

        // ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã®å†æ§‹æˆ
        return {Aggregate}.reconstruct(
            new {Aggregate}Id(entity.getId()),
            new Property1(entity.getProperty1()),
            new Property2(entity.getProperty2()),
            new Property3(entity.getProperty3())
        );
    }

    /**
     * ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒªã‚¹ãƒˆ â†’ ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆ
     */
    public List<{Aggregate}> toDomainList(List<{Aggregate}Entity> entities) {
        return entities.stream()
            .map(this::toDomain)
            .collect(Collectors.toList());
    }
}
```

#### è¨­è¨ˆã®ãƒã‚¤ãƒ³ãƒˆ

1. **å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å¤‰æ›**
   - ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«: å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆ`Property`ï¼‰
   - JPA ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£: ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹ï¼ˆ`String`, `Integer`ï¼‰

2. **ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã®ä½¿ç”¨**
   - `reconstruct()` ã§æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã‚’å¾©å…ƒ
   - `create()` ã¯ä½¿ç”¨ã—ãªã„ï¼ˆæ–°è¦ä½œæˆã§ã¯ãªã„ï¼‰

3. **null ãƒã‚§ãƒƒã‚¯**
   - null ã®å ´åˆã¯ null ã‚’è¿”ã™
   - NullPointerException ã‚’é˜²ã

4. **Stream API ã®æ´»ç”¨**
   - ãƒªã‚¹ãƒˆå¤‰æ›ã« Stream API ã‚’ä½¿ç”¨
   - ã‚³ãƒ¼ãƒ‰ãŒç°¡æ½”ã«ãªã‚‹

---

### 3. Spring Data JPA ãƒªãƒã‚¸ãƒˆãƒª

Spring Data JPA ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç¶™æ‰¿ã—ã€åŸºæœ¬çš„ãª CRUD æ“ä½œã‚’è‡ªå‹•å®Ÿè£…ã—ã¾ã™ã€‚

#### åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³

```java
@Repository
public interface {Aggregate}JpaRepository extends JpaRepository<{Aggregate}Entity, Long> {

    /**
     * ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ãƒªãƒ¡ã‚½ãƒƒãƒ‰
     */

    // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§æ¤œç´¢
    Optional<{Aggregate}Entity> findByProperty1(String property1);

    // è¤‡æ•°æ¡ä»¶ã§æ¤œç´¢
    List<{Aggregate}Entity> findByProperty1AndProperty2(String property1, String property2);

    // LIKE æ¤œç´¢
    List<{Aggregate}Entity> findByProperty1Containing(String keyword);

    // ç¯„å›²æ¤œç´¢
    List<{Aggregate}Entity> findByProperty3Between(Integer min, Integer max);

    // å­˜åœ¨ç¢ºèª
    boolean existsByProperty1(String property1);

    // å‰Šé™¤
    void deleteByProperty1(String property1);

    // @Query ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ãŸã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ãƒª
    @Query("SELECT a FROM {Aggregate}Entity a WHERE a.property1 = :property1 AND a.property3 > :minValue")
    List<{Aggregate}Entity> findByCustomCondition(
        @Param("property1") String property1,
        @Param("minValue") Integer minValue
    );

    // ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¯ã‚¨ãƒª
    @Query(value = "SELECT * FROM {table_name} WHERE property1 = :property1", nativeQuery = true)
    List<{Aggregate}Entity> findByNativeQuery(@Param("property1") String property1);
}
```

#### Spring Data JPA ã®ãƒ¡ã‚½ãƒƒãƒ‰å‘½åè¦å‰‡

```java
// ç­‰ä¾¡æ¤œç´¢
findBy{Property}(Type value)

// AND æ¡ä»¶
findBy{Property1}And{Property2}(Type1 value1, Type2 value2)

// OR æ¡ä»¶
findBy{Property1}Or{Property2}(Type1 value1, Type2 value2)

// LIKE æ¤œç´¢
findBy{Property}Containing(String value)  // %value%
findBy{Property}StartingWith(String value)  // value%
findBy{Property}EndingWith(String value)  // %value

// æ¯”è¼ƒæ¼”ç®—
findBy{Property}LessThan(Type value)  // <
findBy{Property}LessThanEqual(Type value)  // <=
findBy{Property}GreaterThan(Type value)  // >
findBy{Property}GreaterThanEqual(Type value)  // >=

// ç¯„å›²æ¤œç´¢
findBy{Property}Between(Type min, Type max)

// IN å¥
findBy{Property}In(Collection<Type> values)

// NULL ãƒã‚§ãƒƒã‚¯
findBy{Property}IsNull()
findBy{Property}IsNotNull()

// ã‚½ãƒ¼ãƒˆ
findBy{Property}OrderBy{Property2}Asc(Type value)
findBy{Property}OrderBy{Property2}Desc(Type value)

// ä¸Šä½ N ä»¶
findTop10By{Property}(Type value)
findFirst5By{Property}(Type value)

// å­˜åœ¨ç¢ºèª
existsBy{Property}(Type value)

// ã‚«ã‚¦ãƒ³ãƒˆ
countBy{Property}(Type value)

// å‰Šé™¤
deleteBy{Property}(Type value)
```

---

### 4. ãƒªãƒã‚¸ãƒˆãƒªå®Ÿè£…ï¼ˆRepositoryImplï¼‰

ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã®ãƒªãƒã‚¸ãƒˆãƒªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã™ã‚‹ã‚¯ãƒ©ã‚¹ã§ã™ã€‚

#### åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³

```java
@Repository
@RequiredArgsConstructor
public class {Aggregate}RepositoryImpl implements {Aggregate}Repository {

    private final {Aggregate}JpaRepository jpaRepository;
    private final {Aggregate}PersistenceMapper mapper;

    @Override
    public {Aggregate} save({Aggregate} aggregate) {
        // 1. ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ« â†’ JPA ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
        {Aggregate}Entity entity = mapper.toEntity(aggregate);

        // 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
        {Aggregate}Entity savedEntity = jpaRepository.save(entity);

        // 3. JPA ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ â†’ ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«
        return mapper.toDomain(savedEntity);
    }

    @Override
    public void delete({Aggregate} aggregate) {
        {Aggregate}Entity entity = mapper.toEntity(aggregate);
        jpaRepository.delete(entity);
    }

    @Override
    public Optional<{Aggregate}> findById({Aggregate}Id id) {
        return jpaRepository.findById(id.getValue())
            .map(mapper::toDomain);
    }

    @Override
    public Optional<{Aggregate}> findBy{Property}({Property} property) {
        return jpaRepository.findBy{Property}(property.getValue())
            .map(mapper::toDomain);
    }

    @Override
    public List<{Aggregate}> findAll() {
        return jpaRepository.findAll()
            .stream()
            .map(mapper::toDomain)
            .collect(Collectors.toList());
    }

    @Override
    public {Aggregate}Id nextIdentity() {
        // ID ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
        // ä¾‹: UUIDã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã€ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ ãªã©
        return new {Aggregate}Id(UUID.randomUUID().toString());
    }
}
```

#### è¨­è¨ˆã®ãƒã‚¤ãƒ³ãƒˆ

1. **@Repository ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**
   - Spring ã®æ°¸ç¶šåŒ–å±¤ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦ç™»éŒ²
   - ä¾‹å¤–ã®å¤‰æ›ï¼ˆSQLException â†’ DataAccessExceptionï¼‰

2. **ä¾å­˜æ€§æ³¨å…¥**
   - `{Aggregate}JpaRepository`: Spring Data JPA
   - `{Aggregate}PersistenceMapper`: ãƒ‰ãƒ¡ã‚¤ãƒ³ â†” ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å¤‰æ›

3. **å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ‰±ã„**
   - ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã¯å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å—ã‘å–ã‚‹
   - `.getValue()` ã§ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹ã«å¤‰æ›ã—ã¦ JPA ãƒªãƒã‚¸ãƒˆãƒªã«æ¸¡ã™

4. **Optional ã®æ´»ç”¨**
   - æ¤œç´¢çµæœãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ã‚’æ˜ç¤º
   - `map()` ã§ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›

5. **Stream API**
   - ãƒªã‚¹ãƒˆå¤‰æ›ã‚’ç°¡æ½”ã«è¨˜è¿°

---

## ğŸ” ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤ã®è¨­è¨ˆåŸå‰‡

### 1. ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã¸ã®éä¾å­˜

âŒ **æ‚ªã„ä¾‹**: ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã‚’ç›´æ¥è¿”ã™

```java
@Repository
public interface FilmJpaRepository extends JpaRepository<Film, Long> {
    // NG: JPA ãƒªãƒã‚¸ãƒˆãƒªãŒãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã‚’æ‰±ã†
}
```

âœ… **è‰¯ã„ä¾‹**: JPA ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’æ‰±ã„ã€å®Ÿè£…ã‚¯ãƒ©ã‚¹ã§å¤‰æ›

```java
// JPA ãƒªãƒã‚¸ãƒˆãƒªã¯ JPA ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’æ‰±ã†
@Repository
public interface FilmJpaRepository extends JpaRepository<FilmEntity, Long> {
}

// å®Ÿè£…ã‚¯ãƒ©ã‚¹ã§ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›
@Repository
public class FilmRepositoryImpl implements FilmRepository {
    public Film save(Film film) {
        FilmEntity entity = mapper.toEntity(film);
        FilmEntity saved = jpaRepository.save(entity);
        return mapper.toDomain(saved);
    }
}
```

---

### 2. æŠ€è¡“çš„è©³ç´°ã®éš è”½

âœ… **è‰¯ã„ä¾‹**: ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã«æŠ€è¡“ã‚’éœ²å‡ºã—ãªã„

```java
// ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤: æŠ€è¡“éä¾å­˜ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
public interface FilmRepository {
    Film save(Film film);
    Optional<Film> findById(FilmId id);
}

// ã‚¤ãƒ³ãƒ•ãƒ©å±¤: JPA ã‚’ä½¿ã£ãŸå®Ÿè£…
@Repository
public class FilmRepositoryImpl implements FilmRepository {
    private final FilmJpaRepository jpaRepository;  // JPA
    // ...
}
```

---

### 3. ãƒãƒƒãƒ‘ãƒ¼ã«ã‚ˆã‚‹åˆ†é›¢

âœ… **è‰¯ã„ä¾‹**: ãƒãƒƒãƒ‘ãƒ¼ã§å¤‰æ›ã‚’é›†ç´„

```java
@Component
public class FilmPersistenceMapper {
    public FilmEntity toEntity(Film film) {
        // å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯
    }

    public Film toDomain(FilmEntity entity) {
        // å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯
    }
}
```

âŒ **æ‚ªã„ä¾‹**: ãƒªãƒã‚¸ãƒˆãƒªå†…ã§ç›´æ¥å¤‰æ›

```java
@Repository
public class FilmRepositoryImpl implements FilmRepository {
    public Film save(Film film) {
        FilmEntity entity = new FilmEntity();
        entity.setId(film.getId().getValue());  // å¤‰æ›ãŒæ•£ã‚‰ã°ã‚‹
        // ...
    }
}
```

---

## ğŸš€ å®Ÿè·µçš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³

### 1. ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ

```java
@Repository
@RequiredArgsConstructor
public class {Aggregate}RepositoryImpl implements {Aggregate}Repository {

    private final {Aggregate}JpaRepository jpaRepository;
    private final {Aggregate}PersistenceMapper mapper;

    @Override
    public Page<{Aggregate}> findAll(Pageable pageable) {
        Page<{Aggregate}Entity> entityPage = jpaRepository.findAll(pageable);
        return entityPage.map(mapper::toDomain);
    }

    @Override
    public Page<{Aggregate}> findBy{Condition}(
        {Condition} condition,
        Pageable pageable
    ) {
        Page<{Aggregate}Entity> entityPage =
            jpaRepository.findBy{Property}(
                condition.getValue(),
                pageable
            );
        return entityPage.map(mapper::toDomain);
    }
}
```

---

### 2. ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ãƒªã®å®Ÿè£…

```java
@Repository
public interface {Aggregate}JpaRepository extends JpaRepository<{Aggregate}Entity, Long> {

    /**
     * JPQL ã‚’ä½¿ç”¨ã—ãŸã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ãƒª
     */
    @Query("SELECT a FROM {Aggregate}Entity a " +
           "WHERE a.property1 = :property1 " +
           "AND a.property3 > :minValue " +
           "ORDER BY a.createdAt DESC")
    List<{Aggregate}Entity> findByCustomCondition(
        @Param("property1") String property1,
        @Param("minValue") Integer minValue
    );

    /**
     * ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¯ã‚¨ãƒª
     */
    @Query(value = "SELECT * FROM {table_name} " +
                   "WHERE property1 = :property1 " +
                   "AND property3 BETWEEN :min AND :max",
           nativeQuery = true)
    List<{Aggregate}Entity> findByNativeQuery(
        @Param("property1") String property1,
        @Param("min") Integer min,
        @Param("max") Integer max
    );

    /**
     * å‹•çš„ã‚¯ã‚¨ãƒªï¼ˆSpecification ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
     */
    @Query("SELECT a FROM {Aggregate}Entity a WHERE " +
           "(:property1 IS NULL OR a.property1 = :property1) AND " +
           "(:minValue IS NULL OR a.property3 >= :minValue)")
    List<{Aggregate}Entity> findByDynamicCondition(
        @Param("property1") String property1,
        @Param("minValue") Integer minValue
    );
}
```

---

### 3. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†

ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã§ç®¡ç†ã—ã¾ã™ãŒã€ã‚¤ãƒ³ãƒ•ãƒ©å±¤ã§ã‚‚åˆ¶å¾¡å¯èƒ½ã§ã™ã€‚

```java
@Repository
@RequiredArgsConstructor
public class {Aggregate}RepositoryImpl implements {Aggregate}Repository {

    @Transactional(readOnly = true)  // èª­ã¿å–ã‚Šå°‚ç”¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
    @Override
    public List<{Aggregate}> findAll() {
        return jpaRepository.findAll()
            .stream()
            .map(mapper::toDomain)
            .collect(Collectors.toList());
    }

    @Transactional  // æ›¸ãè¾¼ã¿ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
    @Override
    public {Aggregate} save({Aggregate} aggregate) {
        FilmEntity entity = mapper.toEntity(aggregate);
        FilmEntity saved = jpaRepository.save(entity);
        return mapper.toDomain(saved);
    }
}
```

**æ¨å¥¨**: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¯ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼‰ã§ç®¡ç†

---

### 4. N+1 å•é¡Œã®å¯¾ç­–

#### Entity Graph ã®ä½¿ç”¨

```java
@Repository
public interface {Aggregate}JpaRepository extends JpaRepository<{Aggregate}Entity, Long> {

    @EntityGraph(attributePaths = {"relatedEntity", "anotherRelation"})
    @Query("SELECT a FROM {Aggregate}Entity a WHERE a.property1 = :property1")
    List<{Aggregate}Entity> findWithRelations(@Param("property1") String property1);
}
```

#### JOIN FETCH ã®ä½¿ç”¨

```java
@Query("SELECT a FROM {Aggregate}Entity a " +
       "LEFT JOIN FETCH a.relatedEntity " +
       "WHERE a.property1 = :property1")
List<{Aggregate}Entity> findWithRelations(@Param("property1") String property1);
```

---

## ğŸ“ ã¾ã¨ã‚

### ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ

âœ… **æŠ€è¡“çš„å®Ÿè£…ã®é›†ç´„**

- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹
- å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€£æº

âœ… **ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã®ä¿è­·**

- æŠ€è¡“çš„è©³ç´°ã‚’éš è”½
- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…

âœ… **ãƒãƒƒãƒ‘ãƒ¼ã«ã‚ˆã‚‹å¤‰æ›**

- ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ« â†” JPA ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
- å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ â†” ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹

âœ… **Spring Data JPA ã®æ´»ç”¨**

- åŸºæœ¬çš„ãª CRUD ã‚’è‡ªå‹•å®Ÿè£…
- ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ãƒªãƒ¡ã‚½ãƒƒãƒ‰

âœ… **ä¾å­˜é–¢ä¿‚ã®æ–¹å‘**

- ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ä¾å­˜
- ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã¯ ã‚¤ãƒ³ãƒ•ãƒ©å±¤ã«éä¾å­˜

---

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ.md](../ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ.md) - å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®èª¬æ˜
- [ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤.md](./ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤.md) - ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã®è©³ç´°
- [ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤.md](./ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤.md) - ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®å®Ÿè£…
- [ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤.md](./ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤.md) - ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®å®Ÿè£…
