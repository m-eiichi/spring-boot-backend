# データベース連携 API 実装メモ

## 実装日

2025-12-12

## 実装内容

HelloController にデータベースからデータを取得して返す API を実装

## アーキテクチャ

### レイヤー構成

```
presentation/
  └── controller/
      └── HelloController.java       # REST APIエンドポイント

application/
  └── service/
      └── UserService.java           # ビジネスロジック層

domain/
  └── model/
      └── User.java                  # エンティティ（データモデル）

infrastructure/
  ├── repository/
  │   └── UserRepository.java        # データアクセス層（JPA Repository）
  └── config/
      └── DataInitializer.java       # 初期データ投入
```

## 追加した依存関係（pom.xml）

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>runtime</scope>
</dependency>
```

## データベース設定（application.properties）

```properties
# H2 Database Configuration
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=

# JPA Configuration
spring.jpa.database-platform=org.hibernate.dialect.H2Dialect
spring.jpa.hibernate.ddl-auto=create-drop
spring.jpa.show-sql=true

# H2 Console (optional, for debugging)
spring.h2.console.enabled=true
spring.h2.console.path=/h2-console
```

## 実装したクラス

### 1. User.java（エンティティ）

```java
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false)
    private String name;

    @Column(nullable = false)
    private String email;

    // コンストラクタ、getter/setter
}
```

### 2. UserRepository.java（リポジトリ）

```java
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
}
```

### 3. UserService.java（サービス）

```java
@Service
public class UserService {
    private final UserRepository userRepository;

    public List<User> getAllUsers() {
        return userRepository.findAll();
    }

    public User createUser(String name, String email) {
        User user = new User(name, email);
        return userRepository.save(user);
    }
}
```

### 4. HelloController.java（コントローラー）

```java
@RestController
public class HelloController {
    private final UserService userService;

    @GetMapping("/users")
    public List<User> getUsers() {
        return userService.getAllUsers();
    }
}
```

### 5. DataInitializer.java（初期データ投入）

```java
@Component
public class DataInitializer implements CommandLineRunner {
    private final UserService userService;

    @Override
    public void run(String... args) throws Exception {
        userService.createUser("田中太郎", "tanaka@example.com");
        userService.createUser("佐藤花子", "sato@example.com");
        userService.createUser("鈴木一郎", "suzuki@example.com");
    }
}
```

## API エンドポイント

### GET /users

全ユーザーをデータベースから取得して返す

**レスポンス例:**

```json
[
  {
    "id": 1,
    "name": "田中太郎",
    "email": "tanaka@example.com"
  },
  {
    "id": 2,
    "name": "佐藤花子",
    "email": "sato@example.com"
  },
  {
    "id": 3,
    "name": "鈴木一郎",
    "email": "suzuki@example.com"
  }
]
```

## デバッグ方法

### H2 コンソールへのアクセス

- URL: `http://localhost:8080/h2-console`
- JDBC URL: `jdbc:h2:mem:testdb`
- Username: `sa`
- Password: (空白)

## 使用技術

- Spring Boot 3.5.8
- Spring Data JPA
- H2 Database (インメモリ DB)
- Jakarta Persistence API

## メモ

- H2 はインメモリデータベースなので、アプリケーションを停止するとデータは消える
- 本番環境では PostgreSQL や MySQL などの永続化 DB に切り替える必要がある
- `spring.jpa.hibernate.ddl-auto=create-drop` により、起動時にテーブルが自動作成され、停止時に削除される
